#!/usr/bin/env bash

# set -x

functional_name(){
    echo "${1##*.}"
}

is_under_version_control(){
    svn ls "${@}" >/dev/null 2>&1
}

get_extension(){
    extension_revision="${1##*.}"
    extension_only="${extension_revision%%	*}"
    echo "${extension_only}"
}

extension_left=`get_extension "${@: -5:1}"`
extension_right=`get_extension "${@: -3:1}"`

diff_arguments_size="$((${#} - 6))"
diff_arguments="${@:1:${diff_arguments_size}}"

if [[ "${diff_arguments}" = "-u" ]] && [[ "${extension_left}" = "java" ]] \
    && [[ "${extension_right}" = "java" ]]
then
    printf '\nJava files. Ignoring whitespace.\n' 
    diff_arguments="-u -a -w"
fi

printf '\nDiff arguments are: "%s".\n' "${diff_arguments}"

name="$(basename "${@: -1}")"
diff_file="$(mktemp --suffix=".${name}.diff")"
diff ${diff_arguments}  "${@: -1}" "${@: -2:1}" > "${diff_file}"

file1="${@: -2:1}"
file2="${@: -1}"

if ! is_under_version_control "${file1}"
then
    file_name1="`functional_name "${@: -5:1}"`"
fi

if ! is_under_version_control "${file2}"
then
    temp_file="`mktemp --suffix='.'"$(functional_name "${@: -3:1}")"`"
    cp "${file2}" "${temp_file}"
    file2="${temp_file}"
fi

printf '\n%s\n%s\n' "${@: -5:1}" "${@: -3:1}"

vim=/usr/bin/vim

if [[ "${EDITOR}" != "${EDITOR%%vim}" ]]
then
    vim="${EDITOR}"
    printf '\nEditor is: "%s".\n' "${vim}"
fi

"${vim}" -R "${file2}" -c 'sil lefta vert diffpa '\
"${diff_file}"' | sil exe "file " . fnameescape("'"${file_name1}"'") '\
'| sil! set syntax='"${extension_left}"' | exec "normal! \<c-w>l" '\
'| sil! set syntax='"${extension_right}"
