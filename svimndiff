#!/usr/bin/env bash

set -x

echo "${@}"

config_dir=""

if [[ -n "${SVN_CONFIG_DIR}" ]]
then
    config_dir="--config-dir="${SVN_CONFIG_DIR}""
fi

get_file_name(){
    echo "${1##*/}"
}

is_under_version_control(){
    if [[ -n "${config_dir}" ]]
    then
        svn "${config_dir}" ls "${@}" >/dev/null 2>&1
        return 0
    fi
    svn ls "${@}" >/dev/null 2>&1
}

get_extension(){
    extension_revision="${1##*.}"
    extension_only="${extension_revision%%	*}"
    echo "${extension_only}"
}

name_left="${@: -5:1}"
name_right="${@: -3:1}"

extension_left=`get_extension "${name_left}"`
extension_right=`get_extension "${name_right}"`

diff_arguments_size="$((${#} - 6))"
diff_arguments="${@:1:${diff_arguments_size}}"

if [[ "${diff_arguments}" = "-u" ]] && [[ "${extension_left}" = "java" ]] \
    && [[ "${extension_right}" = "java" ]]
then
    printf '\nJava files. Ignoring whitespace.\n'
    diff_arguments="-u -a -w"
fi

printf '\nDiff arguments are: "%s".\n' "${diff_arguments}"

file_left="${@: -2:1}"
file_right="${@: -1}"

name="$(get_file_name "${file_right}")"
diff_file="$(mktemp --suffix=".${name}.diff")"
diff ${diff_arguments} "${file_right}" "${file_left}" > "${diff_file}"

if ! is_under_version_control "${file_right}"
then
    temp_file="`mktemp --suffix=".${file_right}"`"
    cp -v "${file_right}" "${temp_file}"
    file_right="${temp_file}"
fi

printf '\n%s\n%s\n' "${name_left}" "${name_right}"

vim=/usr/bin/vim

if [[ "${EDITOR}" != "${EDITOR%%vim}" ]]
then
    vim="${EDITOR}"
    printf '\nEditor is: "%s".\n' "${vim}"
fi

if is_under_version_control "${file_left}"
then
    "${vim}" "${file_right}" -c 'sil lefta vert diffpa '"${diff_file}"\
    '| sil! set syntax='"${extension_left}"' | wincmd w '\
    '| sil! set syntax='"${extension_right}"

    exit 0
fi

file_name_left="`get_file_name "${name_left}"`"

"${vim}" "${file_right}" -c 'sil lefta vert diffpa '"${diff_file}"\
'| sil exe "file " . fnameescape("'"${file_name_left}"'") '\
'| sil! set syntax='"${extension_left}"' | wincmd w '\
'| sil! set syntax='"${extension_right}"
