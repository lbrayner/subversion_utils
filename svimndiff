#!/usr/bin/env bash

# set -x

# echo "${@}"

config_dir=""

if [[ -n "${SVN_CONFIG_DIR}" ]]
then
    config_dir="--config-dir="${SVN_CONFIG_DIR}""
fi

get_file_name(){
    echo "${1##*/}"
}

tabs_for_spaces(){
    echo "${1//	/ }"
}

is_under_version_control(){
    if [[ -n "${config_dir}" ]]
    then
        svn "${config_dir}" ls "${@}" >/dev/null 2>&1
        return 0
    fi
    svn ls "${@}" >/dev/null 2>&1
}

get_extension(){
    extension_revision="${1##*.}"
    extension_only="${extension_revision%%	*}"
    echo "${extension_only}"
}

path_left="${@: -5:1}"
path_right="${@: -3:1}"

extension_left=`get_extension "${path_left}"`
extension_right=`get_extension "${path_right}"`

diff_arguments_size="$((${#} - 6))"
diff_arguments="${@:1:${diff_arguments_size}}"

diffopt=""

if [[ "${diff_arguments}" == "-w" || \
      "${diff_arguments}" = "-u" && \
      "${extension_left}" = "java" && "${extension_right}" = "java" ]]
then
    printf '\nIgnoring whitespace.\n'
    diffopt="set diffopt+=iwhite |"
fi

vim=/usr/bin/vim

if [[ "${EDITOR}" != "${EDITOR%%vim}" ]]
then
    vim="${EDITOR}"
fi

printf '\nDiff arguments are: "%s".\n' "${diff_arguments}"
printf '%s\n%s\n' "${path_left}" "${path_right}"
printf 'Editor is: "%s".\n\n' "${vim}"

file_left="${@: -2:1}"
file_right="${@: -1}"

if ! is_under_version_control "${file_left}"
then
    name_left="$(get_file_name "${path_left}")"
    name_left_no_tabs="$(tabs_for_spaces "${name_left}")"
    temp_file="$(mktemp -d)/${name_left_no_tabs}"
    cp -v "${file_left}" "${temp_file}"
    file_left="${temp_file}"
fi

if ! is_under_version_control "${file_right}"
then
    name_right="$(get_file_name "${path_right}")"
    name_right_no_tabs="$(tabs_for_spaces "${path_right}")"
    temp_file="$(mktemp -d)/${name_right_no_tabs}"
    cp -v "${file_right}" "${temp_file}"
    file_right="${temp_file}"
fi

"${vim}" -d "${file_left}" "${file_right}"\
    -c "${diffopt}"'silent! set syntax='"${extension_left}"' | wincmd w '\
'| silent! set syntax='"${extension_right}"
