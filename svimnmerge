#!/usr/bin/env bash

# svn merge tool

# set -e

print_usage() {
	printf '\n%s\n' "$(basename $0) OLD HIS MINE MERGED WCPATH"
}

if [[ ! ${#} -eq 5 ]]
then
	print_usage 1>&2
	exit 1
fi

has(){
    if ! hash "${1}"
    then
        printf '%s required.' "${1}" 1>&2
        exit 1
    fi
}

# diff3 required
has diff3

old="${1}"
his="${2}"
mine="${3}"
merged="${4}"
wcpath="${5}"

diff_program=diff
diffopt=""

extension="${merged##*.}"

if [[ "${extension}" = "java" ]]
then
    printf '\nJava file. Ignoring whitespace.\n\n'
    diff_program=diffw
    diffopt="| set diffopt+=iwhite"
fi

# diff_program required
has "${diff_program}"

temp_merged="$(mktemp --suffix=.merged)"

diff3 --diff-program=${diff_program} -A -m "${mine}" "${old}" "${his}" \
    > "${temp_merged}"

# querying for a CARRIAGE RETURN
if grep -q $'\x0d' "${temp_merged}"
then
    if ! hash unix2dos
    then
        printf 'File contains carriage returns: unix2dos required.\n' 1>&2
        exit 1
    fi

    unix2dos -f "${temp_merged}"
fi

cp -fv "${temp_merged}" "${merged}"

vim=/usr/bin/vim

if [[ "${EDITOR}" != "${EDITOR%%vim}" ]]
then
    vim="${EDITOR}"
    printf '\nEditor is: "%s".\n' "${vim}"
fi

# if whithout endif, because bufdo consumes bars
${vim} -d "${mine}" "${old}" "${his}" "${merged}" \
    -c "exec bufwinnr(4) . 'wincmd w' | wincmd J" \
    -c "let merge_ft=&ft | windo silent! let &ft=merge_ft | set nomodifiable" \
    -c "unlet merge_ft | silent set modifiable ${diffopt}"
